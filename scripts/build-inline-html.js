#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

function readFile(filePath) {
  return fs.readFileSync(filePath, 'utf8');
}

function ensureDir(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
}

function escapeScriptContent(source) {
  return source.replace(/<\/(script)/gi, '<\\/$1');
}

function buildHtml({ cssBlocks, scripts }) {
  const styles = cssBlocks.join('\n');
  const scriptTags = scripts
    .map((content) => `<script>${escapeScriptContent(content)}</script>`)
    .join('\n');

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fabric.js Image Editor</title>
<style>${styles}</style>
</head>
<body>
<div id="image-editor-container"></div>
${scriptTags}
</body>
</html>
`;
}

function writeReactNativeModule(targetPath, html) {
  const content = `// This file is auto-generated by scripts/build-inline-html.js.\n` +
    `// Do not edit manually.\n` +
    `const editorHtml = ${JSON.stringify(html)};\n` +
    `export default editorHtml;\n` +
    `export { editorHtml };\n`;

  fs.writeFileSync(targetPath, content, 'utf8');
}

function main() {
  const root = path.resolve(__dirname, '..');

  const cssFiles = [
    path.join(root, 'vendor', 'spectrum.min.css'),
    path.join(root, 'vendor', 'grapick.min.css'),
    path.join(root, 'lib', 'style.css'),
    path.join(root, 'lib', 'style-custom.css')
  ];

  const jsEntries = [
    { type: 'file', path: path.join(root, 'vendor', 'jquery-3.5.1.min.js') },
    {
      type: 'inline',
      content: `;(function(){\n  if (typeof jQuery !== 'undefined') {\n    jQuery.fn.outerHTML = function () {\n      return jQuery('<div />').append(this.eq(0).clone()).html();\n    };\n  }\n  Number.prototype.countDecimals = function () {\n    if (Math.floor(this.valueOf()) === this.valueOf()) return 0;\n    const parts = this.toString().split('.');\n    return parts[1] ? parts[1].length : 0;\n  };\n})();`
    },
    { type: 'file', path: path.join(root, 'vendor', 'fabric.min.js') },
    { type: 'file', path: path.join(root, 'vendor', 'spectrum.min.js') },
    { type: 'file', path: path.join(root, 'vendor', 'lodash.min.js') },
    { type: 'file', path: path.join(root, 'vendor', 'grapick.min.js') },
    { type: 'file', path: path.join(root, 'vendor', 'undo-redo-stack.js') },
    { type: 'file', path: path.join(root, 'vendor', 'context-menu.js') },
    { type: 'file', path: path.join(root, 'dist', 'fabricjs-image-editor-origin.js') },
    { type: 'file', path: path.join(root, 'bootstrap.js') }
  ];

  cssFiles.forEach((filePath) => {
    if (!fs.existsSync(filePath)) {
      throw new Error(`Missing CSS dependency: ${path.relative(root, filePath)}`);
    }
  });

  jsEntries.forEach((entry) => {
    if (entry.type === 'file' && !fs.existsSync(entry.path)) {
      throw new Error(`Missing JS dependency: ${path.relative(root, entry.path)}`);
    }
  });

  const cssBlocks = cssFiles.map(readFile);
  const scripts = jsEntries.map((entry) =>
    entry.type === 'inline' ? entry.content : readFile(entry.path)
  );

  const html = buildHtml({ cssBlocks, scripts });

  const distDir = path.join(root, 'dist');
  ensureDir(distDir);
  fs.writeFileSync(path.join(distDir, 'editor-inline.html'), html, 'utf8');

  const rnDir = path.join(root, 'react-native');
  ensureDir(rnDir);
  writeReactNativeModule(path.join(rnDir, 'editorHtml.js'), html);
}

if (require.main === module) {
  try {
    main();
  } catch (error) {
    console.error(error);
    process.exit(1);
  }
}
