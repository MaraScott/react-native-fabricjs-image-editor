#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

function readFile(filePath) {
  return fs.readFileSync(filePath, 'utf8');
}

function ensureDir(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
}

function escapeScriptContent(source) {
  return source.replace(/<\/(script)/gi, '<\\/$1');
}

function buildHtml({ css, bundle }) {
  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fabric.js React Image Editor</title>
<style>${css}</style>
</head>
<body>
<div id="image-editor-container"></div>
<script>${escapeScriptContent(bundle)}</script>
</body>
</html>
`;
}

function writeReactNativeModule(targetPath, html) {
  const content = `// This file is auto-generated by scripts/build-inline-html.js.\n` +
    `// Do not edit manually.\n` +
    `const editorHtml = ${JSON.stringify(html)};\n` +
    `export default editorHtml;\n` +
    `export { editorHtml };\n`;

  fs.writeFileSync(targetPath, content, 'utf8');
}

function main() {
  const root = path.resolve(__dirname, '..');
  const css = readFile(path.join(root, 'lib', 'react-app.css'));
  const bundlePath = path.join(root, 'dist', 'react-app.bundle.js');
  if (!fs.existsSync(bundlePath)) {
    throw new Error('Missing dist/react-app.bundle.js. Run npm run build first.');
  }

  const bundle = readFile(bundlePath);

  const html = buildHtml({ css, bundle });

  const distDir = path.join(root, 'dist');
  ensureDir(distDir);
  fs.writeFileSync(path.join(distDir, 'editor-inline.html'), html, 'utf8');

  const rnDir = path.join(root, 'react-native');
  ensureDir(rnDir);
  writeReactNativeModule(path.join(rnDir, 'editorHtml.js'), html);
}

if (require.main === module) {
  try {
    main();
  } catch (error) {
    console.error(error);
    process.exit(1);
  }
}
